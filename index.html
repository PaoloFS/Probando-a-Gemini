<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AURA v11.0 | NEURAL CORE</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
  :root {
    --c0: #050810;
    --c1: #0a0f1e;
    --c2: #0f1929;
    --accent: #00e5ff;
    --accent2: #7b2fff;
    --accent3: #ff2d7a;
    --text: #c8d6f0;
    --text-dim: #4a6080;
    --glass: rgba(10,15,30,0.85);
    --border: rgba(0,229,255,0.12);
    --glow: 0 0 30px rgba(0,229,255,0.15);
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--c0);
    color: var(--text);
    height: 100dvh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  /* Background grid */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background-image:
      linear-gradient(rgba(0,229,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,229,255,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }
  body::after {
    content: '';
    position: fixed; inset: 0;
    background: radial-gradient(ellipse 60% 50% at 15% 80%, rgba(123,47,255,0.12) 0%, transparent 70%),
                radial-gradient(ellipse 50% 40% at 85% 10%, rgba(0,229,255,0.08) 0%, transparent 70%);
    pointer-events: none;
    z-index: 0;
  }

  #app { position: relative; z-index: 1; display: flex; flex-direction: column; height: 100dvh; max-width: 860px; margin: 0 auto; width: 100%; }

  /* â”€â”€ HEADER â”€â”€ */
  header {
    padding: 14px 24px;
    display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid var(--border);
    background: rgba(5,8,16,0.9);
    backdrop-filter: blur(20px);
    flex-shrink: 0;
  }
  .logo {
    font-family: 'Space Mono', monospace;
    font-size: 15px; letter-spacing: 3px; color: var(--accent);
    display: flex; align-items: center; gap: 10px;
  }
  .logo-dot {
    width: 8px; height: 8px; border-radius: 50%;
    background: var(--accent);
    box-shadow: 0 0 12px var(--accent);
    animation: blink 2s ease-in-out infinite;
  }
  @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }

  .header-badges { display: flex; gap: 8px; align-items: center; }
  .hbadge {
    font-size: 10px; font-family: 'Space Mono', monospace;
    padding: 4px 10px; border-radius: 4px;
    border: 1px solid; letter-spacing: 1px;
  }
  .hbadge.mem { color: #7b2fff; border-color: rgba(123,47,255,0.3); background: rgba(123,47,255,0.08); }
  .hbadge.stream { color: var(--accent); border-color: rgba(0,229,255,0.3); background: rgba(0,229,255,0.08); }

  /* â”€â”€ STATUS BAR â”€â”€ */
  #status-bar {
    height: 28px; padding: 0 24px;
    display: flex; align-items: center; gap: 10px;
    font-size: 11px; font-family: 'Space Mono', monospace;
    color: var(--text-dim); letter-spacing: 0.5px;
    border-bottom: 1px solid rgba(0,229,255,0.05);
    background: rgba(5,8,16,0.6);
    flex-shrink: 0;
    transition: all 0.3s;
  }
  #status-bar.active { color: var(--accent); }
  #status-bar .status-dot {
    width: 5px; height: 5px; border-radius: 50%;
    background: currentColor; flex-shrink: 0;
  }

  /* â”€â”€ MEMORY PANEL â”€â”€ */
  #mem-panel {
    position: fixed; top: 0; right: -340px; width: 320px; height: 100dvh;
    background: rgba(5,8,16,0.97); border-left: 1px solid var(--border);
    z-index: 100; transition: right 0.4s cubic-bezier(0.16,1,0.3,1);
    display: flex; flex-direction: column;
    backdrop-filter: blur(30px);
  }
  #mem-panel.open { right: 0; }
  #mem-panel header {
    padding: 20px; border-bottom: 1px solid var(--border);
    font-family: 'Space Mono', monospace; font-size: 12px;
    color: var(--accent); letter-spacing: 2px;
  }
  #mem-list { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; gap: 8px; }
  .mem-item {
    padding: 12px; border-radius: 8px;
    background: rgba(123,47,255,0.08); border: 1px solid rgba(123,47,255,0.2);
    font-size: 12px; color: var(--text);
    cursor: pointer; transition: all 0.2s;
  }
  .mem-item:hover { background: rgba(123,47,255,0.15); }
  .mem-item .mem-key { font-family: 'Space Mono', monospace; color: #7b2fff; font-size: 10px; margin-bottom: 4px; }
  .mem-item .mem-val { color: var(--text-dim); font-size: 11px; }
  #mem-panel footer { padding: 16px; border-top: 1px solid var(--border); }
  .mem-clear-btn {
    width: 100%; padding: 10px; background: rgba(255,45,122,0.1);
    border: 1px solid rgba(255,45,122,0.3); border-radius: 8px;
    color: var(--accent3); font-family: 'Space Mono', monospace; font-size: 11px;
    cursor: pointer; transition: all 0.2s; letter-spacing: 1px;
  }
  .mem-clear-btn:hover { background: rgba(255,45,122,0.2); }

  /* â”€â”€ CHAT FLOW â”€â”€ */
  #chat-flow {
    flex: 1; overflow-y: auto; padding: 24px 24px 0;
    display: flex; flex-direction: column; gap: 20px;
    scroll-behavior: smooth;
  }
  #chat-flow::-webkit-scrollbar { width: 4px; }
  #chat-flow::-webkit-scrollbar-thumb { background: rgba(0,229,255,0.15); border-radius: 4px; }

  .msg-row { display: flex; gap: 12px; animation: fadeSlide 0.3s cubic-bezier(0.16,1,0.3,1); }
  .msg-row.user { flex-direction: row-reverse; }
  @keyframes fadeSlide { from{opacity:0;transform:translateY(12px)} to{opacity:1;transform:translateY(0)} }

  .avatar {
    width: 32px; height: 32px; border-radius: 8px; flex-shrink: 0;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Space Mono', monospace; font-size: 10px; font-weight: 700;
  }
  .avatar.ai { background: rgba(0,229,255,0.1); border: 1px solid rgba(0,229,255,0.3); color: var(--accent); }
  .avatar.user { background: rgba(123,47,255,0.15); border: 1px solid rgba(123,47,255,0.3); color: #7b2fff; }

  .bubble {
    max-width: calc(100% - 60px); padding: 14px 18px;
    border-radius: 12px; font-size: 14.5px; line-height: 1.65;
    position: relative;
  }
  .bubble.ai {
    background: var(--c2); border: 1px solid var(--border);
    color: var(--text); border-top-left-radius: 4px;
  }
  .bubble.user {
    background: rgba(123,47,255,0.15); border: 1px solid rgba(123,47,255,0.25);
    color: #e2d4ff; border-top-right-radius: 4px;
  }

  /* Intent badge */
  .intent-badge {
    display: inline-flex; align-items: center; gap: 5px;
    font-size: 9px; font-family: 'Space Mono', monospace;
    padding: 3px 8px; border-radius: 4px; margin-bottom: 10px;
    letter-spacing: 1px; text-transform: uppercase;
  }
  .intent-badge.search { background: rgba(0,229,255,0.08); color: var(--accent); border: 1px solid rgba(0,229,255,0.25); }
  .intent-badge.chat   { background: rgba(123,47,255,0.08); color: #a78bfa; border: 1px solid rgba(123,47,255,0.25); }
  .intent-badge.image  { background: rgba(255,45,122,0.08); color: var(--accent3); border: 1px solid rgba(255,45,122,0.25); }
  .intent-badge.memory { background: rgba(123,47,255,0.12); color: #c4b5fd; border: 1px solid rgba(123,47,255,0.3); }

  /* Markdown inside AI bubbles */
  .bubble.ai p { margin-bottom: 10px; }
  .bubble.ai p:last-child { margin-bottom: 0; }
  .bubble.ai strong { color: #fff; }
  .bubble.ai em { color: #94a3b8; }
  .bubble.ai code {
    font-family: 'Space Mono', monospace; font-size: 12px;
    background: rgba(0,0,0,0.4); color: var(--accent);
    padding: 2px 7px; border-radius: 4px;
  }
  .bubble.ai pre {
    background: #000; border: 1px solid rgba(0,229,255,0.1);
    border-radius: 8px; padding: 14px; overflow-x: auto; margin: 10px 0;
  }
  .bubble.ai pre code { background: none; padding: 0; color: #e2e8f0; font-size: 13px; }
  .bubble.ai ul, .bubble.ai ol { padding-left: 20px; margin: 8px 0; }
  .bubble.ai li { margin-bottom: 4px; }
  .bubble.ai h1,.bubble.ai h2,.bubble.ai h3 { color: #fff; margin: 14px 0 8px; }
  .bubble.ai a { color: var(--accent); text-decoration: none; }
  .bubble.ai a:hover { text-decoration: underline; }
  .bubble.ai blockquote {
    border-left: 3px solid var(--accent2); padding-left: 12px;
    color: var(--text-dim); margin: 8px 0;
  }

  /* Streaming cursor */
  .stream-cursor::after {
    content: 'â–‹'; color: var(--accent);
    animation: cursorBlink 0.7s step-end infinite;
  }
  @keyframes cursorBlink { 0%,100%{opacity:1} 50%{opacity:0} }

  /* Memory context pill */
  .mem-context-pill {
    font-size: 10px; font-family: 'Space Mono', monospace;
    color: #7b2fff; margin-bottom: 8px; opacity: 0.7;
    display: flex; align-items: center; gap: 5px;
  }

  /* Image generation */
  .img-skeleton {
    width: 100%; height: 280px; border-radius: 10px; margin-top: 12px;
    background: linear-gradient(90deg, rgba(0,229,255,0.03) 25%, rgba(0,229,255,0.08) 50%, rgba(0,229,255,0.03) 75%);
    background-size: 200% 100%; animation: shimmer 1.5s infinite;
    border: 1px solid var(--border);
  }
  @keyframes shimmer { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
  .gen-img { width:100%; border-radius:10px; margin-top:12px; border: 1px solid var(--border); display:none; }

  /* Thinking state */
  .thinking-row { display: flex; gap: 12px; }
  .thinking-bubble {
    padding: 12px 18px; border-radius: 12px; border-top-left-radius: 4px;
    background: var(--c2); border: 1px solid var(--border);
    font-size: 12px; font-family: 'Space Mono', monospace;
    color: var(--text-dim); letter-spacing: 0.5px;
    animation: pulseOpacity 1.5s ease-in-out infinite;
  }
  @keyframes pulseOpacity { 0%,100%{opacity:0.4} 50%{opacity:1} }

  /* â”€â”€ INPUT AREA â”€â”€ */
  #input-area {
    padding: 16px 24px 20px;
    background: rgba(5,8,16,0.9);
    border-top: 1px solid var(--border);
    backdrop-filter: blur(20px);
    flex-shrink: 0;
  }

  /* Drag-over state */
  #input-area.drag-over { border-top-color: var(--accent); background: rgba(0,229,255,0.03); }

  .input-toolbar {
    display: flex; gap: 8px; margin-bottom: 10px;
    overflow-x: auto; padding-bottom: 2px;
  }
  .tool-btn {
    padding: 5px 12px; border-radius: 6px; border: 1px solid var(--border);
    background: transparent; color: var(--text-dim);
    font-size: 11px; font-family: 'Space Mono', monospace; letter-spacing: 0.5px;
    cursor: pointer; transition: all 0.2s; white-space: nowrap; display:flex; align-items:center; gap:5px;
  }
  .tool-btn:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,0.05); }
  .tool-btn.active { border-color: var(--accent); color: var(--accent); background: rgba(0,229,255,0.08); }

  .input-row { display: flex; gap: 10px; align-items: flex-end; }
  #userInput {
    flex: 1; min-height: 48px; max-height: 140px;
    padding: 13px 18px; border-radius: 10px;
    border: 1px solid var(--border); background: rgba(255,255,255,0.02);
    color: var(--text); font-family: 'DM Sans', sans-serif; font-size: 14.5px;
    outline: none; resize: none; transition: all 0.25s;
    overflow-y: auto;
  }
  #userInput:focus { border-color: rgba(0,229,255,0.4); background: rgba(0,229,255,0.02); box-shadow: var(--glow); }
  #userInput::placeholder { color: var(--text-dim); }

  .send-btn {
    padding: 13px 24px; border-radius: 10px; border: none;
    background: var(--accent); color: var(--c0);
    font-family: 'Space Mono', monospace; font-weight: 700; font-size: 12px;
    letter-spacing: 1px; cursor: pointer; transition: all 0.2s;
    flex-shrink: 0; height: 48px;
  }
  .send-btn:hover { box-shadow: 0 0 20px rgba(0,229,255,0.4); transform: translateY(-1px); }
  .send-btn:disabled { opacity: 0.4; cursor: not-allowed; transform: none; box-shadow: none; }

  /* Voice btn */
  .voice-btn {
    width: 48px; height: 48px; border-radius: 10px; border: 1px solid var(--border);
    background: transparent; color: var(--text-dim); cursor: pointer; transition: all 0.2s;
    display: flex; align-items: center; justify-content: center; font-size: 18px;
    flex-shrink: 0;
  }
  .voice-btn:hover { border-color: var(--accent3); color: var(--accent3); }
  .voice-btn.listening { border-color: var(--accent3); color: var(--accent3); background: rgba(255,45,122,0.1); animation: pulseOpacity 1s infinite; }

  /* Image preview */
  #img-preview-area { margin-bottom: 10px; display: none; }
  #img-preview-area img { height: 60px; border-radius: 8px; border: 1px solid var(--accent); }

  /* FOOTER hint */
  .footer-hint {
    margin-top: 8px; font-size: 10px; color: var(--text-dim);
    font-family: 'Space Mono', monospace; letter-spacing: 0.3px; text-align: center;
  }
</style>
</head>
<body>

<div id="app">
  <header>
    <div class="logo">
      <div class="logo-dot"></div>
      AURA<span style="color:var(--text-dim);font-weight:400"> v11.0</span>
    </div>
    <div class="header-badges">
      <div class="hbadge stream">STREAM</div>
      <div class="hbadge mem" style="cursor:pointer" onclick="toggleMemPanel()">â¬¡ MEMORIA</div>
    </div>
  </header>

  <div id="status-bar">
    <div class="status-dot"></div>
    <span id="status-text">SISTEMA LISTO â€” PROTOCOLO NEURAL ACTIVO</span>
  </div>

  <div id="chat-flow">
    <div class="msg-row">
      <div class="avatar ai">A</div>
      <div class="bubble ai">
        <div class="intent-badge chat">âš¡ NEURAL CORE</div>
        <p>Sistema v11.0 inicializado. Estoy ejecutando con:</p>
        <p><strong>â†’ Streaming en tiempo real</strong> â€” leerÃ¡s mi respuesta mientras la genero.<br>
        <strong>â†’ Memoria vectorial</strong> â€” recuerdo conversaciones pasadas via IndexedDB.<br>
        <strong>â†’ Tool Use simulado</strong> â€” selecciono herramientas (bÃºsqueda, imÃ¡genes, anÃ¡lisis) con lÃ³gica avanzada.<br>
        <strong>â†’ Voz</strong> â€” activa el micrÃ³fono con el botÃ³n ğŸ¤ o arrastra una imagen.</p>
        <p>Â¿Por dÃ³nde empezamos?</p>
      </div>
    </div>
    <div id="thinking-placeholder" style="display:none" class="thinking-row">
      <div class="avatar ai">A</div>
      <div class="thinking-bubble" id="thinking-text">Analizando intent...</div>
    </div>
  </div>

  <div id="input-area" id="drop-zone">
    <div class="input-toolbar">
      <button class="tool-btn" onclick="insertPrefix('dibuja ')">ğŸ¨ Imagen</button>
      <button class="tool-btn" onclick="setForceSearch(true)" id="btn-search">ğŸŒ Forzar Web</button>
      <button class="tool-btn" onclick="toggleMemPanel()">â¬¡ Memoria</button>
      <button class="tool-btn" onclick="clearChat()">âœ• Limpiar</button>
    </div>
    <div id="img-preview-area"><img id="img-preview" src="" alt=""></div>
    <div class="input-row">
      <textarea id="userInput" rows="1" placeholder="Habla, pregunta o arrastra una imagen..." autofocus></textarea>
      <button class="voice-btn" id="voiceBtn" onclick="toggleVoice()" title="Voz">ğŸ¤</button>
      <button class="send-btn" id="sendBtn" onclick="handleSend()">SEND</button>
    </div>
    <div class="footer-hint">STREAMING ACTIVO Â· INDEXEDDB MEMORY Â· TOOL USE ENGINE v2</div>
  </div>
</div>

<!-- Memory Panel -->
<div id="mem-panel">
  <header>â¬¡ MEMORIA VECTORIAL</header>
  <div id="mem-list"></div>
  <footer>
    <button class="mem-clear-btn" onclick="clearMemory()">âœ• PURGAR MEMORIA</button>
  </footer>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AURA v11.0 â€” ARQUITECTURA NEURAL COMPLETA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

marked.setOptions({ breaks: true, gfm: true });

// â”€â”€ STATE â”€â”€
let chatHistory = [];
let isProcessing = false;
let forceSearch = false;
let pendingImageBase64 = null;
let mediaRecognition = null;

// â”€â”€ DOM REFS â”€â”€
const flow = document.getElementById('chat-flow');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const thinkingEl = document.getElementById('thinking-placeholder');
const thinkingText = document.getElementById('thinking-text');
const statusText = document.getElementById('status-text');
const statusBar = document.getElementById('status-bar');

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO 1: MEMORIA VECTORIAL (IndexedDB)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const DB_NAME = 'AURA_MEMORY_v11';
const DB_VERSION = 2;
let db = null;

async function initDB() {
  return new Promise((res, rej) => {
    const req = indexedDB.open(DB_NAME, DB_VERSION);
    req.onupgradeneeded = e => {
      const d = e.target.result;
      if (!d.objectStoreNames.contains('memories')) {
        const store = d.createObjectStore('memories', { keyPath: 'id', autoIncrement: true });
        store.createIndex('timestamp', 'timestamp');
        store.createIndex('keywords', 'keywords', { multiEntry: true });
      }
    };
    req.onsuccess = e => { db = e.target.result; res(); };
    req.onerror = () => rej();
  });
}

// Extrae keywords simples (TF-IDF aproximado)
function extractKeywords(text) {
  const stopwords = new Set(['el','la','los','las','un','una','de','del','y','en','a','que','es','se','con','para','por','como','pero','este','estÃ¡','son','mÃ¡s','su','al','lo','me','mi','hay','ya','muy','bien','todo','si','cuando','tambiÃ©n','sobre','entre','sin','te','nos','fue','ser','una','tiene','han','era','tiene','esta','aquÃ­','asÃ­','donde','hasta','desde','porque','aunque']);
  return text.toLowerCase()
    .replace(/[^a-zÃ¡Ã©Ã­Ã³ÃºÃ¼Ã±\s]/g,'')
    .split(/\s+/)
    .filter(w => w.length > 3 && !stopwords.has(w))
    .slice(0, 12);
}

async function saveMemory(userMsg, aiResponse) {
  if (!db) return;
  const combined = `${userMsg} ${aiResponse}`;
  const keywords = extractKeywords(combined);
  if (keywords.length < 2) return;
  
  const mem = {
    user: userMsg.slice(0, 200),
    ai: aiResponse.slice(0, 300),
    keywords,
    timestamp: Date.now()
  };
  
  return new Promise(res => {
    const tx = db.transaction('memories', 'readwrite');
    tx.objectStore('memories').add(mem);
    tx.oncomplete = res;
  });
}

async function retrieveMemories(query) {
  if (!db) return [];
  const queryKeywords = extractKeywords(query);
  if (!queryKeywords.length) return [];
  
  return new Promise(res => {
    const tx = db.transaction('memories', 'readonly');
    const store = tx.objectStore('memories');
    const all = [];
    store.openCursor().onsuccess = e => {
      const cursor = e.target.result;
      if (cursor) {
        const mem = cursor.value;
        const score = mem.keywords.filter(k => queryKeywords.some(q => k.includes(q) || q.includes(k))).length;
        if (score > 0) all.push({ ...mem, score });
        cursor.continue();
      } else {
        res(all.sort((a,b) => b.score - a.score).slice(0, 3));
      }
    };
  });
}

async function getAllMemories() {
  if (!db) return [];
  return new Promise(res => {
    const tx = db.transaction('memories', 'readonly');
    const all = [];
    tx.objectStore('memories').openCursor().onsuccess = e => {
      const cursor = e.target.result;
      if (cursor) { all.push(cursor.value); cursor.continue(); }
      else res(all.sort((a,b) => b.timestamp - a.timestamp).slice(0, 30));
    };
  });
}

async function clearMemory() {
  if (!db) return;
  const tx = db.transaction('memories', 'readwrite');
  tx.objectStore('memories').clear();
  renderMemPanel();
  setStatus('MEMORIA PURGADA');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO 2: INTENT ROUTER v2
// Usa LLM-as-classifier con 1 token de respuesta
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function classifyIntent(text) {
  // Fallback rÃ¡pido para frases muy cortas o saludos
  const t = text.toLowerCase().trim();
  if (t.length < 4) return 'CHAT';
  if (/^(hola|hey|hi|hello|adios|bye|gracias|ok|si|no|jaja|xd)[\s!.,]*$/.test(t)) return 'CHAT';
  if (/^(dibuja|genera una imagen|crea una imagen|pinta|imagina|render|muÃ©strame una foto)/i.test(t)) return 'IMAGE';
  if (forceSearch) return 'SEARCH';

  // LLM-as-classifier: prompt ultra compacto
  try {
    const res = await fetch('https://text.pollinations.ai/', {
      method: 'POST', headers: {'Content-Type':'application/json'},
      body: JSON.stringify({
        messages: [
          { role: 'system', content: 'You are a classifier. Reply with ONLY one word: CHAT, SEARCH, or IMAGE. SEARCH = factual/news/current events. IMAGE = generate image. CHAT = conversation/opinion/code/explain.' },
          { role: 'user', content: text.slice(0, 120) }
        ],
        model: 'mistral', seed: 42
      }),
      signal: AbortSignal.timeout(3000)
    });
    const raw = (await res.text()).trim().toUpperCase().replace(/[^A-Z]/g,'');
    if (['CHAT','SEARCH','IMAGE'].includes(raw)) return raw;
  } catch(e) {}
  
  // Regex fallback
  if (/(noticias|quien|quiÃ©n|precio|clima|hoy|2024|2025|2026|president|latest|cuÃ¡l es el|actualidad)/i.test(t)) return 'SEARCH';
  return 'CHAT';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO 3: WEB SEARCH (mejorado con mÃºltiples snippets)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function webSearch(query) {
  setStatus('ğŸŒ BUSCANDO EN RED PÃšBLICA...');
  const q = query.replace(/\b(quien|quiÃ©n|quÃ©|que|como|cÃ³mo|donde|cuÃ¡ndo|cuando|dime|busca|buscar|el|la|los|las|un|una)\b/gi,'').trim();
  if (q.length < 3) return '';
  
  try {
    const url = `https://api.allorigins.win/get?url=${encodeURIComponent('https://html.duckduckgo.com/html/?q=' + encodeURIComponent(q) + '&kl=es-419')}`;
    const res = await fetch(url, { signal: AbortSignal.timeout(6000) });
    const data = await res.json();
    const parser = new DOMParser();
    const doc = parser.parseFromString(data.contents, 'text/html');
    const snippets = Array.from(doc.querySelectorAll('.result__snippet')).slice(0,4).map(el => el.innerText.trim()).filter(Boolean);
    const titles = Array.from(doc.querySelectorAll('.result__title')).slice(0,4).map(el => el.innerText.trim()).filter(Boolean);
    if (!snippets.length) return '';
    return titles.map((t,i) => `â€¢ ${t}: ${snippets[i]||''}`).join('\n');
  } catch(e) { return ''; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO 4: SYSTEM PROMPT DINÃMICO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildSystemPrompt(webContext, memContext, hasImage) {
  const now = new Date();
  const date = now.toLocaleDateString('es-PE', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  const time = now.toLocaleTimeString('es-PE', { hour:'2-digit', minute:'2-digit' });

  let sys = `Eres AURA v11.0, una IA avanzada, directa y brillante. Fecha actual: ${date}, ${time}.
Responde siempre en el idioma del usuario. SÃ© conciso pero completo. Usa Markdown cuando aÃ±ada valor (cÃ³digo, tablas, listas).
Si el usuario pide una imagen, responde SOLO con: [IMG]descripciÃ³n hiper-realista en inglÃ©s, ultra-detailed, 8k, photorealistic[/IMG]`;

  if (memContext.length) {
    sys += `\n\n[MEMORIA VECTORIAL â€” Conversaciones relevantes previas del usuario]:
${memContext.map(m => `Q: "${m.user}" â†’ A: "${m.ai}"`).join('\n')}
Usa este contexto solo si es relevante.`;
  }

  if (webContext) {
    sys += `\n\n[DATOS FRESCOS DE INTERNET â€” ${time}]:
${webContext}
Sintetiza estos datos en tu respuesta de forma natural y precisa.`;
  }

  if (hasImage) {
    sys += `\n\nEl usuario ha adjuntado una imagen. AnalÃ­zala con detalle.`;
  }

  return sys;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO 5: STREAMING ENGINE
// ReadableStream + TextDecoder â€” sin esperar respuesta completa
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function streamResponse(messages, onChunk, onDone) {
  const payload = { messages, stream: true };
  
  const res = await fetch('https://text.pollinations.ai/', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload)
  });

  if (!res.ok) throw new Error(`HTTP ${res.status}`);

  const reader = res.body.getReader();
  const decoder = new TextDecoder();
  let full = '';
  let buffer = '';

  while (true) {
    const { done, value } = await reader.read();
    if (done) break;
    const chunk = decoder.decode(value, { stream: true });
    
    // Pollinations puede enviar SSE o texto plano
    // Manejamos ambos casos
    buffer += chunk;
    const lines = buffer.split('\n');
    buffer = lines.pop() || '';
    
    for (const line of lines) {
      if (line.startsWith('data: ')) {
        const data = line.slice(6).trim();
        if (data === '[DONE]') continue;
        try {
          const parsed = JSON.parse(data);
          const text = parsed.choices?.[0]?.delta?.content || '';
          if (text) { full += text; onChunk(full); }
        } catch {
          // Si no es JSON, es texto plano en streaming
          if (data) { full += data + ' '; onChunk(full); }
        }
      } else if (line.trim() && !line.startsWith(':')) {
        // Texto plano (Pollinations a veces no usa SSE)
        full += line + '\n';
        onChunk(full);
      }
    }
  }
  
  // Procesar buffer restante
  if (buffer.trim()) { full += buffer; onChunk(full); }
  onDone(full);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO 6: PROCESADOR PRINCIPAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function processMessage(text) {
  if (isProcessing || !text.trim()) return;
  isProcessing = true;
  sendBtn.disabled = true;

  // Render user bubble
  addUserBubble(text);
  chatHistory.push({ role: 'user', content: pendingImageBase64 ? [
    { type: 'image_url', image_url: { url: pendingImageBase64 } },
    { type: 'text', text }
  ] : text });

  const hasImage = !!pendingImageBase64;
  pendingImageBase64 = null;
  clearImgPreview();

  // Show thinking
  showThinking('ğŸ” Clasificando intent...');

  // Classify intent
  const intent = await classifyIntent(text);
  setStatus(`INTENT: ${intent} Â· PROCESANDO...`);
  statusBar.classList.add('active');

  // Retrieve memories
  showThinking('â¬¡ Buscando en memoria vectorial...');
  const memories = await retrieveMemories(text);

  // Web search if needed
  let webContext = '';
  if (intent === 'SEARCH') {
    showThinking('ğŸŒ Consultando fuentes en tiempo real...');
    webContext = await webSearch(text);
  }

  // Build messages
  const systemPrompt = buildSystemPrompt(webContext, memories, hasImage);
  const messages = [
    { role: 'system', content: systemPrompt },
    ...chatHistory.slice(-10)
  ];

  // Create AI bubble for streaming
  hideThinking();
  const { bubbleEl, contentEl } = createAIBubble(intent, memories.length > 0);

  let fullResponse = '';

  try {
    if (intent === 'IMAGE') {
      showThinking('ğŸ¨ Generando imagen...');
      // For images, we don't stream, we get the full prompt first
      const res = await fetch('https://text.pollinations.ai/', {
        method: 'POST', headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ messages })
      });
      hideThinking();
      const aiText = await res.text();
      const match = aiText.match(/\[IMG\](.*?)\[\/IMG\]/s);
      const prompt = match ? match[1] : text;
      const finalPrompt = `${prompt}, photorealistic, hyperrealistic, ultra-detailed, 8k RAW photo, cinematic lighting, no cartoon, no anime`;
      renderImageBubble(contentEl, finalPrompt);
      fullResponse = aiText;
    } else {
      // STREAMING âœ¨
      showThinking('ğŸ’¬ Generando respuesta en streaming...');
      hideThinking();
      
      await streamResponse(
        messages,
        (partial) => {
          // Update bubble in real-time
          contentEl.innerHTML = marked.parse(partial);
          contentEl.classList.add('stream-cursor');
          flow.scrollTop = flow.scrollHeight;
        },
        (final) => {
          fullResponse = final;
          contentEl.innerHTML = marked.parse(final);
          contentEl.classList.remove('stream-cursor');
          flow.scrollTop = flow.scrollHeight;
        }
      );
    }

    // Save to memory
    chatHistory.push({ role: 'assistant', content: fullResponse });
    await saveMemory(text, fullResponse);
    
  } catch (err) {
    hideThinking();
    contentEl.innerHTML = `<p style="color:var(--accent3)">Error de red. Reintentando... <code>${err.message}</code></p>`;
    contentEl.classList.remove('stream-cursor');
  }

  setStatus('SISTEMA LISTO');
  statusBar.classList.remove('active');
  forceSearch = false;
  document.getElementById('btn-search').classList.remove('active');
  isProcessing = false;
  sendBtn.disabled = false;
  renderMemPanel();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addUserBubble(text) {
  const row = document.createElement('div');
  row.className = 'msg-row user';
  row.innerHTML = `<div class="avatar user">U</div><div class="bubble user">${escHtml(text)}</div>`;
  flow.insertBefore(row, document.getElementById('thinking-placeholder'));
  flow.scrollTop = flow.scrollHeight;
}

function createAIBubble(intent, hasMemory) {
  const row = document.createElement('div');
  row.className = 'msg-row';

  const badgeMap = {
    SEARCH: `<div class="intent-badge search">ğŸŒ BÃšSQUEDA WEB</div>`,
    IMAGE:  `<div class="intent-badge image">ğŸ¨ IMAGEN</div>`,
    CHAT:   `<div class="intent-badge chat">ğŸ’¬ RAZONAMIENTO</div>`,
  };
  const memPill = hasMemory ? `<div class="mem-context-pill">â¬¡ contexto de memoria recuperado</div>` : '';

  const contentEl = document.createElement('div');
  contentEl.className = 'bubble ai';
  contentEl.innerHTML = badgeMap[intent] || badgeMap.CHAT;
  if (hasMemory) contentEl.insertAdjacentHTML('beforeend', memPill);

  const innerContent = document.createElement('div');
  contentEl.appendChild(innerContent);

  row.innerHTML = `<div class="avatar ai">A</div>`;
  row.appendChild(contentEl);
  flow.insertBefore(row, document.getElementById('thinking-placeholder'));
  flow.scrollTop = flow.scrollHeight;

  return { bubbleEl: row, contentEl: innerContent };
}

function renderImageBubble(contentEl, prompt) {
  const id = 'img_' + Date.now();
  contentEl.innerHTML = `AquÃ­ tienes la imagen generada:<div id="sk_${id}" class="img-skeleton"></div>
    <img src="https://image.pollinations.ai/prompt/${encodeURIComponent(prompt)}?width=1024&height=576&nologo=true&model=flux"
         class="gen-img" id="${id}"
         onload="document.getElementById('sk_${id}').style.display='none';this.style.display='block'"
         onerror="document.getElementById('sk_${id}').innerHTML='<p style=color:var(--accent3)>Error generando imagen</p>'">`;
}

function showThinking(msg) {
  thinkingText.textContent = msg;
  thinkingEl.style.display = 'flex';
  flow.scrollTop = flow.scrollHeight;
}
function hideThinking() { thinkingEl.style.display = 'none'; }

function setStatus(msg) { statusText.textContent = msg; }

function escHtml(s) {
  return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

// Memory panel
function toggleMemPanel() {
  document.getElementById('mem-panel').classList.toggle('open');
  renderMemPanel();
}

async function renderMemPanel() {
  const list = document.getElementById('mem-list');
  const mems = await getAllMemories();
  if (!mems.length) {
    list.innerHTML = '<p style="color:var(--text-dim);font-size:12px;padding:8px;font-family:Space Mono,monospace">Sin memorias almacenadas.</p>';
    return;
  }
  list.innerHTML = mems.map(m => `
    <div class="mem-item">
      <div class="mem-key">${new Date(m.timestamp).toLocaleString('es-PE')} Â· [${m.keywords.slice(0,3).join(', ')}]</div>
      <div class="mem-val"><strong>Q:</strong> ${m.user.slice(0,80)}...</div>
    </div>
  `).join('');
}

function clearChat() {
  const msgs = flow.querySelectorAll('.msg-row:not(#thinking-placeholder)');
  msgs.forEach(m => m.remove());
  chatHistory = [];
  setStatus('CHAT LIMPIADO');
}

function insertPrefix(prefix) {
  userInput.value = prefix + userInput.value;
  userInput.focus();
}

function setForceSearch(val) {
  forceSearch = val;
  document.getElementById('btn-search').classList.toggle('active', val);
}

// â”€â”€ AUTO-RESIZE TEXTAREA â”€â”€
userInput.addEventListener('input', () => {
  userInput.style.height = 'auto';
  userInput.style.height = Math.min(userInput.scrollHeight, 140) + 'px';
});

userInput.addEventListener('keydown', e => {
  if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); }
});

function handleSend() {
  const text = userInput.value.trim();
  if (!text) return;
  userInput.value = '';
  userInput.style.height = '48px';
  processMessage(text);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO 7: VOICE INPUT (Web Speech API)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let isListening = false;
function toggleVoice() {
  if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
    alert('Tu navegador no soporta reconocimiento de voz. Usa Chrome.');
    return;
  }
  const voiceBtn = document.getElementById('voiceBtn');
  if (isListening) {
    mediaRecognition?.stop();
    isListening = false;
    voiceBtn.classList.remove('listening');
    return;
  }
  const SR = window.SpeechRecognition || window.webkitSpeechRecognition;
  mediaRecognition = new SR();
  mediaRecognition.lang = 'es-PE';
  mediaRecognition.interimResults = true;
  mediaRecognition.onresult = e => {
    const transcript = Array.from(e.results).map(r => r[0].transcript).join('');
    userInput.value = transcript;
  };
  mediaRecognition.onend = () => {
    isListening = false;
    voiceBtn.classList.remove('listening');
    if (userInput.value.trim()) handleSend();
  };
  mediaRecognition.start();
  isListening = true;
  voiceBtn.classList.add('listening');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MÃ“DULO 8: IMAGE DRAG & DROP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const inputArea = document.getElementById('input-area');
inputArea.addEventListener('dragover', e => { e.preventDefault(); inputArea.classList.add('drag-over'); });
inputArea.addEventListener('dragleave', () => inputArea.classList.remove('drag-over'));
inputArea.addEventListener('drop', e => {
  e.preventDefault();
  inputArea.classList.remove('drag-over');
  const file = e.dataTransfer.files[0];
  if (file && file.type.startsWith('image/')) loadImageFile(file);
});

function loadImageFile(file) {
  const reader = new FileReader();
  reader.onload = e => {
    pendingImageBase64 = e.target.result;
    document.getElementById('img-preview').src = pendingImageBase64;
    document.getElementById('img-preview-area').style.display = 'block';
    userInput.placeholder = 'Imagen lista. Â¿QuÃ© quieres saber sobre ella?';
    userInput.focus();
  };
  reader.readAsDataURL(file);
}

function clearImgPreview() {
  document.getElementById('img-preview-area').style.display = 'none';
  document.getElementById('img-preview').src = '';
  userInput.placeholder = 'Habla, pregunta o arrastra una imagen...';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
(async () => {
  await initDB();
  setStatus('SISTEMA LISTO â€” v11.0 NEURAL CORE ACTIVO');
})();
</script>
</body>
</html>
