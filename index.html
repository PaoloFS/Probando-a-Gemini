<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AURA v7.0 | RAG Engine</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        :root {
            --primary: #8b5cf6;
            --secondary: #ec4899; /* Cambi√© el secundario a un tono m√°s vibrante para la v7 */
            --bg: #0f172a;
            --glass: rgba(30, 41, 59, 0.7);
            --text: #f8fafc;
        }

        body {
            margin: 0;
            font-family: 'Outfit', sans-serif;
            background: radial-gradient(circle at top right, #311042, var(--bg));
            color: var(--text);
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #aura-container {
            width: 95%;
            max-width: 1000px;
            height: 85vh;
            background: var(--glass);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 24px;
            display: flex;
            flex-direction: column;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            overflow: hidden;
        }

        header {
            padding: 20px 30px;
            background: rgba(15, 23, 42, 0.6);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
        }

        .ai-pulse {
            width: 12px;
            height: 12px;
            background: var(--secondary);
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
            box-shadow: 0 0 15px var(--secondary);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0.7); }
            70% { transform: scale(1); box-shadow: 0 0 0 10px rgba(236, 72, 153, 0); }
            100% { transform: scale(0.95); box-shadow: 0 0 0 0 rgba(236, 72, 153, 0); }
        }

        #chat-flow {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 25px;
            scroll-behavior: smooth;
        }

        .bubble {
            max-width: 85%;
            padding: 20px 25px;
            border-radius: 20px;
            font-size: 15px;
            line-height: 1.6;
            animation: slideUp 0.3s ease-out;
            position: relative;
        }

        .user-bubble {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            border-bottom-right-radius: 4px;
        }

        .ai-bubble {
            align-self: flex-start;
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            color: #e2e8f0;
            border-bottom-left-radius: 4px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        /* Renderizado Markdown */
        .ai-bubble p { margin-top: 0; margin-bottom: 12px; }
        .ai-bubble p:last-child { margin-bottom: 0; }
        .ai-bubble strong { color: #fff; font-weight: 600; }
        .ai-bubble ul, .ai-bubble ol { margin: 10px 0; padding-left: 20px; }
        .ai-bubble li { margin-bottom: 5px; }
        .ai-bubble table { width: 100%; border-collapse: collapse; margin: 15px 0; background: rgba(0,0,0,0.2); border-radius: 8px; overflow: hidden; }
        .ai-bubble th, .ai-bubble td { border: 1px solid rgba(255,255,255,0.1); padding: 10px 15px; text-align: left; }
        .ai-bubble th { background: rgba(255,255,255,0.1); color: var(--secondary); font-weight: 600; }
        .ai-bubble tr:nth-child(even) { background: rgba(255,255,255,0.02); }

        .speak-btn {
            position: absolute;
            bottom: -28px;
            left: 10px;
            background: transparent;
            border: none;
            color: #94a3b8;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: color 0.2s;
        }

        .speak-btn:hover { color: var(--secondary); }

        .rag-badge {
            font-size: 10px;
            background: rgba(236, 72, 153, 0.2);
            color: var(--secondary);
            padding: 2px 8px;
            border-radius: 10px;
            border: 1px solid rgba(236, 72, 153, 0.5);
            margin-bottom: 10px;
            display: inline-block;
        }

        .typing {
            align-self: flex-start;
            color: var(--secondary);
            font-size: 13px;
            font-weight: 600;
            display: none;
            background: rgba(255,255,255,0.02);
            padding: 10px 20px;
            border-radius: 20px;
            animation: pulseText 1.5s infinite;
        }

        @keyframes pulseText { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }

        .input-wrapper {
            padding: 20px 30px;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            gap: 15px;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.05);
        }

        input { flex: 1; padding: 16px 25px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); color: white; outline: none; font-size: 16px; font-family: inherit; transition: 0.3s; }
        input:focus { border-color: var(--secondary); background: rgba(255,255,255,0.08); }
        button.send-btn { padding: 16px 30px; background: white; color: var(--bg); border: none; border-radius: 16px; cursor: pointer; font-weight: 600; font-size: 16px; transition: 0.3s; }
        button.send-btn:hover { transform: translateY(-2px); box-shadow: 0 5px 20px rgba(255,255,255,0.2); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 10px; }
    </style>
</head>
<body>

<div id="aura-container">
    <header>
        <div style="font-size: 20px; font-weight: 600; letter-spacing: 1px;">AURA <span style="color: var(--secondary); font-weight: 300;">v7.0 RAG</span></div>
        <div style="font-size: 13px; color: #cbd5e1;"><span class="ai-pulse"></span> Sistema RAG (Web Search) Activo</div>
    </header>

    <div id="chat-flow">
        <div class="bubble ai-bubble">
            <div class="rag-badge">üåê Conexi√≥n en Vivo Establecida</div>
            <p>He integrado un m√≥dulo <strong>RAG</strong>. Ahora, si me preguntas sobre eventos actuales o personas, buscar√© silenciosamente en la red para actualizar mis pesos neuronales antes de responderte.</p>
            <p>Preg√∫ntame qui√©n es el presidente ahora mismo.</p>
        </div>
        <div class="typing" id="typing-indicator">Iniciando protocolos...</div>
    </div>

    <form class="input-wrapper" id="chat-form">
        <input type="text" id="userInput" placeholder="Habla conmigo libremente..." autofocus autocomplete="off">
        <button type="submit" class="send-btn">Enviar</button>
    </form>
</div>

<script>
    const flow = document.getElementById('chat-flow');
    const form = document.getElementById('chat-form');
    const input = document.getElementById('userInput');
    const typing = document.getElementById('typing-indicator');

    let chatHistory = [];
    const synth = window.speechSynthesis;
    marked.setOptions({ breaks: true });

    function getSystemPrompt() {
        const now = new Date();
        const time = now.toLocaleTimeString('es-PE', { hour: '2-digit', minute: '2-digit' });
        const date = now.toLocaleDateString('es-PE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        return `Eres AURA, un asistente de Inteligencia Artificial.
        Usuario: Paolo. Ubicaci√≥n: Ica, Per√∫.
        Fecha Actual del Sistema: Hoy es ${date} (Febrero 2026). Hora: ${time}.
        Regla ORO: Tienes una fecha de corte de conocimiento, PERO se te proporcionar√° contexto en tiempo real extra√≠do de internet si el usuario hace preguntas de actualidad. USA SIEMPRE el contexto en tiempo real para dar respuestas exactas sobre el presente (2026).
        Responde en el mismo idioma del usuario. Usa Markdown para formatear.`;
    }

    async function fetchRealTimeContext(query) {
        // Detectar si la consulta es en ingl√©s para buscar en la wiki correcta
        const isEnglish = /(who|what|where|when|how|is|are|the|president)/i.test(query);
        const lang = isEnglish ? 'en' : 'es';
        
        // Limpiar la consulta para buscar solo palabras clave
        const cleanQuery = query.replace(/(quien|que|como|cuando|donde|is|who|what|where|when|the|a|of|el|la|los|las)/gi, "").trim();
        
        if (cleanQuery.length < 3) return "";

        try {
            // Buscamos en la Wikipedia en vivo
            const searchRes = await fetch(`https://${lang}.wikipedia.org/w/api.php?action=query&list=search&srsearch=${encodeURIComponent(cleanQuery)}&format=json&origin=*`);
            const searchData = await searchRes.json();
            
            if (searchData.query.search.length > 0) {
                const title = searchData.query.search[0].title;
                const pageRes = await fetch(`https://${lang}.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title)}`);
                const pageData = await pageRes.json();
                return pageData.extract; // Este es el dato fresco de internet
            }
        } catch (e) {
            console.log("Fallo en la extracci√≥n de datos en vivo.");
        }
        return "";
    }

    async function processAura(userText) {
        addBubble(userText, 'user-bubble', false, true);
        
        typing.style.display = 'block';
        typing.innerText = "üîç AURA est√° escaneando la red mundial...";
        flow.appendChild(typing);
        flow.scrollTop = flow.scrollHeight;

        chatHistory.push({ role: 'user', content: userText });

        // PASO 1: Ejecutar RAG (B√∫squeda invisible)
        const liveContext = await fetchRealTimeContext(userText);
        
        // PASO 2: Inyectar el dato en el cerebro del LLM
        let systemPrompt = getSystemPrompt();
        let wasRagUsed = false;
        if (liveContext) {
            systemPrompt += `\n\n[CONTEXTO DE INTERNET EN VIVO EXTRA√çDO AHORA MISMO]: "${liveContext}". \nUtiliza estrictamente esta informaci√≥n para responder si aplica a la pregunta.`;
            wasRagUsed = true;
        }

        const messages = [
            { role: 'system', content: systemPrompt },
            ...chatHistory.slice(-6)
        ];

        try {
            typing.innerText = "üß† AURA est√° sintetizando la respuesta...";
            const response = await fetch('https://text.pollinations.ai/', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ messages: messages })
            });

            if (!response.ok) throw new Error('Network error');
            
            const aiText = await response.text();
            
            typing.style.display = 'none';
            chatHistory.push({ role: 'assistant', content: aiText });
            
            addBubble(aiText, 'ai-bubble', true, false, wasRagUsed);

        } catch (error) {
            typing.style.display = 'none';
            addBubble("Error en el n√∫cleo cognitivo. Por favor, intenta de nuevo.", 'ai-bubble', false, false);
        }
    }

    function addBubble(text, className, addVoice = false, isUser = false, wasRagUsed = false) {
        const div = document.createElement('div');
        div.className = `bubble ${className}`;
        
        let contentHtml = "";
        
        if (!isUser) {
            // Si la IA us√≥ datos de internet, mostramos una peque√±a insignia
            if (wasRagUsed) {
                contentHtml += `<div class="rag-badge">üåê Datos en vivo utilizados</div>`;
            }
            contentHtml += marked.parse(text);
            div.innerHTML = contentHtml;
        } else {
            div.innerText = text;
        }

        if (addVoice) {
            const btn = document.createElement('button');
            btn.className = 'speak-btn';
            btn.innerHTML = '‚ñ∂ Escuchar';
            const plainText = text.replace(/[*_#|`]/g, '');
            btn.onclick = () => speak(plainText);
            div.appendChild(btn);
        }

        flow.insertBefore(div, typing);
        flow.scrollTop = flow.scrollHeight;
    }

    function speak(text) {
        synth.cancel();
        const utterance = new SpeechSynthesisUtterance(text);
        const isEnglish = /^[a-zA-Z\s.,?!]+$/.test(text.substring(0, 30)); 
        utterance.lang = isEnglish ? 'en-US' : 'es-PE';
        
        const voices = synth.getVoices();
        const preferredVoice = voices.find(v => v.lang.includes('es') && v.name.includes('Google'));
        if (preferredVoice) utterance.voice = preferredVoice;
        
        synth.speak(utterance);
    }

    form.onsubmit = (e) => {
        e.preventDefault();
        if (input.value.trim()) {
            processAura(input.value);
            input.value = '';
        }
    };
</script>
</body>
</html>
